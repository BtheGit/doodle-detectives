<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Doodle Detective Lobby</title>
  <link rel="stylesheet" href="/styles/lobby.css">
</head>
<body>

    <div class="header-container">
      <div class="logo-image">
        <img src="/images/title2.png">
      </div>
      <div><a href="/user/profile">Profile</a></div>
      <div><a href="/user/logout">Logout</a></div>
    </div>
    <div class="container">
      <div id="lobby-users"></div>
      <div class="button-container">
        <div id="menu-container">
          <div class="loading-rooms">Loading <span>.</span> <span>.</span> <span>.</span></div>
          <!-- <div class="newRoomContainer"> -->
          <!-- </div> -->
        </div>
        <a href="/doodle/room" class="action-button">+</a>
        
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io.connect('/lobby')
      const menuContainer = document.getElementById('menu-container'); 
      const usersContainer = document.getElementById('lobby-users')
      let menuUpdateHandler;

      socket.on('connect', () => {
        console.log('Connected to server')
        menuUpdateHandler = setInterval(reqUpdates, 1000);
      })
      socket.on('disconnected', () => {
        clearInterval(menuUpdateHandler);
      })
      
      socket.on('getUpdate', (pkt) => {
        updateRoomsMenu(pkt.rooms);
        updateLobbyUsers(pkt.users);
      })

      function reqUpdates() {
        socket.emit('reqUpdate');
      }


      function updateRoomsMenu(array = []) {
        let content = '';
        if(array.length) {
          for (let i = 0; i < array.length; i++) {
            const link = array[i].pop >= 8 
                            ? `<p class="full-button">ROOM FULL</p>` 
                            : `<a class="join-button" href="/doodle/room/${array[i].sessionId}">JOIN</a>`
            const room =
                   `<div class="room-container">
                    <div class="room-name">
                      ${array[i].clients}
                    </div>
                    <div class="room-pop">
                      ${array[i].pop} / 8
                    </div>
                    <div class="room-link">
                      ${link}
                    </div>
                  </div>`;
            content += room
          }
        } else {
          content=`<div class='room-container no-cases'><p>NO OPEN CASES</p></div>`
        }
        menuContainer.innerHTML = content;
      }

      /**
       * Manually update container div with user list
       * @param  {Array} userList [Array of strings of user names]
       * 
       */
      function updateLobbyUsers(userList = []) {
        let content = '';
        if (userList.length) {
          content = userList.map(user => {
            return `<div class="user">${user}</div>`
          })
          content = `<div class="user-title">UNASSIGNED</div><div class="user-list">${content.join('')}</div>`;
        }
        else {
          content=`<div class="user-list"><div class="user">Lobby Empty</div></div>`
        }
        usersContainer.innerHTML = content;
      }

    </script>
</body>
</html>