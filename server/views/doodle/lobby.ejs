<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Doodle Detective Lobby</title>
  <link rel="stylesheet" href="/styles/lobby.css">
</head>
<body>

    <div id="logoFlexBox">
      <h1>Doodle Detective</h1>
      <div><a href="/user/profile">Profile</a></div>
      <div><a href="/user/logout">Logout</a></div>
    </div>
    <div id="menuContainer"></div>
    <div id="lobbyUsers"></div>
    <div id="newRoomContainer">
      <a href="/doodle/room" class="action-button shadow">Create New Room</a>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io.connect('/lobby')
      const menuContainer = document.getElementById('menuContainer'); 
      const usersContainer = document.getElementById('lobbyUsers')
      let menuUpdateHandler;

      socket.on('connect', () => {
        console.log('Connected to server')
        menuUpdateHandler = setInterval(reqUpdates, 1000);
      })
      socket.on('disconnected', () => {
        clearInterval(menuUpdateHandler);
      })
      
      socket.on('getUpdate', (pkt) => {
        updateRoomsMenu(pkt.rooms);
        updateLobbyUsers(pkt.users);
      })

      function reqUpdates() {
        socket.emit('reqUpdate');
      }


      function updateRoomsMenu(array = []) {
        let content = '';
        if(array.length) {
          for (let i = 0; i < array.length; i++) {
            const link = array[i].pop >= 8 
                            ? `<p class="full-button">ROOM FULL</p>` 
                            : `<a class="join-button" href="/doodle/room/${array[i].sessionId}">JOIN</a>`
            const room =
                   `<div class="roomContainer">
                    <div class="roomName">
                      ${array[i].clients}
                    </div>
                    <div class="roomPop">
                      ${array[i].pop} / 8
                    </div>
                    <div class="roomLink">
                      ${link}
                    </div>
                  </div>`;
            content += room
          }
        } else {
          content=`<div class='roomContainer'>NO ACTIVE ROOMS</div>`
        }
        menuContainer.innerHTML = content;
      }

      /**
       * Manually update container div with user list
       * @param  {Array} userList [Array of strings of user names]
       * 
       */
      function updateLobbyUsers(userList = []) {
        let content = '';
        if (userList.length) {
          content = userList.map(user => {
            return `<div class="user">${user}</div>`
          })
        }
        else {
          content=`<div class="user">Lobby Empty</div>`
        }
        usersContainer.innerHTML = content;
      }

    </script>
</body>
</html>